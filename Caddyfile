cat > Caddyfile.pyapi <<'EOF'
:80 {
  encode zstd gzip

  # 1) PYTHON (més específiques) — mantenim el path complet
  @py_kpis path /api/v1/kpis*
  handle @py_kpis {
    header { X-Served-By api_py }
    reverse_proxy api_py:8000
  }

  @py_forecast path /api/v1/forecast*
  handle @py_forecast {
    header { X-Served-By api_py }
    reverse_proxy api_py:8000
  }

  # 2) LEGACY Node/Express (catch-all)
  @api_legacy path /api/* /tasks/*
  handle @api_legacy {
    header { X-Served-By backend }
    reverse_proxy backend:3000
  }

  # 3) Health (si el vols al backend)
  @health path /health
  handle @health {
    reverse_proxy backend:3000
  }

  # 4) Estàtics
  handle {
    root * /srv
    try_files {path} /index.html
    file_server
  }
}
EOF
