<html lang="ca">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tecnolord — Lectures Meteo</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:2rem;line-height:1.4}
      .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin-bottom:1rem}
      input,select,button{padding:.5rem .7rem;border:1px solid #ccc;border-radius:.5rem}
      button{cursor:pointer}
      table{border-collapse:collapse;width:100%;margin-top:.5rem}
      th,td{border:1px solid #e5e7eb;padding:.5rem;text-align:left;font-size:.95rem}
      th{background:#f5f5f5}
      .muted{color:#666;font-size:.9rem}
      .err{color:#b00020}
    </style>
  </head>
  <body>
    <h1>Lectures Meteo</h1>
    <div class="row">
      <label>Estació <input id="station" value="home" /></label>
      <label>Límit <input id="limit" type="number" min="1" max="1000" value="20" style="width:6rem" /></label>
      <label><input id="auto" type="checkbox" /> Auto (30s)</label>
      <button id="btn">Refresca</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="error" class="err"></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>Hora</th><th>Temp (°C)</th><th>Hum (%)</th><th>Pressió (hPa)</th>
          <th>Pluja (mm)</th><th>Vent (m/s)</th><th>Direcció (°)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const $ = sel => document.querySelector(sel);
      const stationEl = $('#station');
      const limitEl   = $('#limit');
      const autoEl    = $('#auto');
      const btn       = $('#btn');
      const statusEl  = $('#status');
      const errEl     = $('#error');
      const tbody     = $('#tbl tbody');
      let timer = null;

      // Llegeix paràmetres d’URL (?station_id=...&limit=...)
      const url = new URL(location.href);
      if (url.searchParams.get('station_id')) stationEl.value = url.searchParams.get('station_id');
      if (url.searchParams.get('limit'))      limitEl.value   = url.searchParams.get('limit');

      function fmtTime(iso) {
        try { return new Date(iso).toLocaleString(); } catch { return iso || ''; }
      }
      function setStatus(msg){ statusEl.textContent = msg; }
      function setError(msg){ errEl.textContent = msg || ''; }

      async function load() {
        setError('');
        setStatus('Carregant…');
        const station = stationEl.value.trim();
        const limit = Math.max(1, Math.min(1000, parseInt(limitEl.value || '20', 10)));
        const qs = new URLSearchParams({ limit: String(limit) });
        if (station) qs.set('station_id', station);

        try {
          const res = await fetch('/api/v1/measurements/latest?' + qs.toString());
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const { ok, items, error } = await res.json();
          if (!ok) throw new Error(error || 'error');

          tbody.innerHTML = (items || []).map(row => `
            <tr>
              <td>${fmtTime(row.at)}</td>
              <td>${row.temp_c ?? ''}</td>
              <td>${row.humidity ?? ''}</td>
              <td>${row.pressure_hpa ?? ''}</td>
              <td>${row.rain_mm ?? ''}</td>
              <td>${row.wind_speed_ms ?? ''}</td>
              <td>${row.wind_dir_deg ?? ''}</td>
            </tr>
          `).join('');
          setStatus(`Mostrant ${items.length} registres${station ? ' — estació: ' + station : ''}`);
        } catch (e) {
          setError('Error carregant dades: ' + (e.message || e));
          setStatus('');
        }
      }

      btn.addEventListener('click', load);
      autoEl.addEventListener('change', () => {
        if (autoEl.checked) {
          if (timer) clearInterval(timer);
          timer = setInterval(load, 30000);
          load();
        } else {
          if (timer) clearInterval(timer);
        }
      });

      // primera càrrega
      load();
    </script>
  </body>
</html>