<!doctype html>
<html lang="ca">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tecnolord — Lectures Meteo</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:2rem;line-height:1.4}
      .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin-bottom:1rem}
      input,select,button{padding:.5rem .7rem;border:1px solid #ccc;border-radius:.5rem}
      button{cursor:pointer}
      table{border-collapse:collapse;width:100%;margin-top:.5rem}
      th,td{border:1px solid #e5e7eb;padding:.5rem;text-align:left;font-size:.95rem}
      th{background:#f5f5f5}
      .muted{color:#666;font-size:.9rem}
      .err{color:#b00020}
    </style>
  </head>
  <body>
    <h1>Lectures Meteo</h1>
    <div class="row">
      <label>Estació <input id="estacio" value="home" /></label>
      <label>Límit <input id="limit" type="number" min="1" max="1000" value="20" style="width:6rem" /></label>
      <label><input id="auto" type="checkbox" /> Auto (30s)</label>
      <button id="btn">Refresca</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="error" class="err"></div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Temp (°C)</th>
          <th>Sensació (°C)</th>
          <th>Hum (%)</th>
          <th>Pressió rel (hPa)</th>
          <th>Pluja dia (mm)</th>
          <th>Vent (m/s)</th>
          <th>Ràfega (m/s)</th>
          <th>Direcció (°)</th>
          <th>UVI</th>
          <th>Solar (W/m²)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const $ = sel => document.querySelector(sel);
      const estacioEl = $('#estacio');
      const limitEl   = $('#limit');
      const autoEl    = $('#auto');
      const btn       = $('#btn');
      const statusEl  = $('#status');
      const errEl     = $('#error');
      const tbody     = $('#tbl tbody');
      let timer = null;

      // Accepta ?estacio= i també (compat) ?station_id=
      const url = new URL(location.href);
      const estFromUrl = url.searchParams.get('estacio') || url.searchParams.get('station_id');
      if (estFromUrl) estacioEl.value = estFromUrl;
      if (url.searchParams.get('limit')) limitEl.value = url.searchParams.get('limit');

      function fmtTime(iso) {
        try { return new Date(iso).toLocaleString(); } catch { return iso || ''; }
      }
      function setStatus(msg){ statusEl.textContent = msg; }
      function setError(msg){ errEl.textContent = msg || ''; }

      function cell(v){ return v == null ? '' : v; }

      async function load() {
        setError('');
        setStatus('Carregant…');
        const estacio = estacioEl.value.trim();
        const limit = Math.max(1, Math.min(1000, parseInt(limitEl.value || '20', 10)));
        const qs = new URLSearchParams({ limit: String(limit) });
        if (estacio) qs.set('estacio', estacio);

        try {
          // Nou endpoint en català
          const res = await fetch('/api/v1/mesures/darreres?' + qs.toString());
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const { ok, items, error } = await res.json();
          if (!ok) throw new Error(error || 'error');

          // Dibuixa files (amb compatibilitat de camps antics)
          tbody.innerHTML = (items || []).map(row => {
            const instant           = row.instant ?? row.at;
            const temp_c            = row.temp_c ?? row.temperature;
            const sensacio_c        = row.sensacio_c ?? row.feels_like ?? row.feels_like_c;
            const humitat_pct       = row.humitat_pct ?? row.humidity;
            const pressio_rel_hpa   = row.pressio_rel_hpa ?? row.pressure_hpa ?? row.pressure_rel_hpa;
            const pluja_diaria_mm   = row.pluja_diaria_mm ?? row.rain_mm ?? row.rain_daily_mm;
            const vent_ms           = row.vent_ms ?? row.wind_speed_ms;
            const vent_rafega_ms    = row.vent_rafega_ms ?? row.wind_gust_ms;
            const vent_dir_graus    = row.vent_direccio_graus ?? row.wind_dir_deg;
            const uvi               = row.uvi;
            const solar_wm2         = row.solar_wm2;

            return `
              <tr>
                <td>${fmtTime(instant)}</td>
                <td>${cell(temp_c)}</td>
                <td>${cell(sensacio_c)}</td>
                <td>${cell(humitat_pct)}</td>
                <td>${cell(pressio_rel_hpa)}</td>
                <td>${cell(pluja_diaria_mm)}</td>
                <td>${cell(vent_ms)}</td>
                <td>${cell(vent_rafega_ms)}</td>
                <td>${cell(vent_dir_graus)}</td>
                <td>${cell(uvi)}</td>
                <td>${cell(solar_wm2)}</td>
              </tr>`;
          }).join('');

          setStatus(`Mostrant ${items?.length ?? 0} registres${estacio ? ' — estació: ' + estacio : ''}`);
        } catch (e) {
          setError('Error carregant dades: ' + (e.message || e));
          setStatus('');
        }
      }

      btn.addEventListener('click', load);
      autoEl.addEventListener('change', () => {
        if (autoEl.checked) {
          if (timer) clearInterval(timer);
          timer = setInterval(load, 30000);
          load();
        } else {
          if (timer) clearInterval(timer);
        }
      });

      load();
    </script>
  </body>
</html>
